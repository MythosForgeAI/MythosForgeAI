<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MythosForgeAI - Prototype</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif; 
        }
        #chat-output::-webkit-scrollbar, #error-log-output::-webkit-scrollbar {
            width: 8px;
        }
        #chat-output::-webkit-scrollbar-track, #error-log-output::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        #chat-output::-webkit-scrollbar-thumb, #error-log-output::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 10px;
        }
        #chat-output::-webkit-scrollbar-thumb:hover, #error-log-output::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        .chat-bubble { max-width: 80%; padding: 10px 15px; border-radius: 18px; margin-bottom: 10px; word-wrap: break-word; line-height: 1.5; }
        .user-bubble { background-color: #c8e6c9; align-self: flex-end; border-bottom-right-radius: 5px; }
        .ai-bubble { background-color: #e0e0e0; align-self: flex-start; border-bottom-left-radius: 5px; position: relative; } /* Added position relative for reroll button */
        .message-container { display: flex; flex-direction: column; }
        .settings-input { padding: 10px; border: 1px solid #D1D5DB; border-radius: 8px; margin-bottom: 8px; width: 100%; box-sizing: border-box; }
        #error-log-output {
            max-height: 100px; 
            overflow-y: auto;
            border: 1px solid #fecaca; 
            padding: 8px;
            margin-top: 10px;
            border-radius: 8px;
            background-color: #fff5f5; 
        }
        .error-message {
            padding: 4px;
            font-size: 0.875rem; 
            color: #b91c1c; 
            background-color: #fee2e2; 
            border-radius: 4px;
            margin-bottom: 4px;
            word-wrap: break-word;
        }
        /* Style for a reroll button that could appear next to AI messages - more advanced */
        /* .reroll-ai-msg-btn {
            position: absolute;
            bottom: -5px;
            right: -5px;
            background-color: #cbd5e1;
            color: #475569;
            border: none;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 10px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0.5;
            transition: opacity 0.2s;
        }
        .ai-bubble:hover .reroll-ai-msg-btn {
            opacity: 1;
        } */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
    </style>
</head>
<body class="bg-gray-200 flex flex-col items-center justify-center min-h-screen p-2 md:p-4">

    <div class="w-full max-w-4xl bg-white shadow-2xl rounded-xl flex flex-col h-[95vh] md:h-[90vh] mt-2 md:mt-0">
        <header class="bg-indigo-700 text-white p-4 rounded-t-xl flex items-center justify-between">
            <h1 class="text-xl md:text-2xl font-semibold">MythosForgeAI - Chat Prototype</h1>
            <div></div> 
        </header>

        <div class="flex-1 flex flex-col md:flex-row overflow-hidden">
            <div class="w-full md:w-1/3 lg:w-1/4 p-3 md:p-4 border-b md:border-b-0 md:border-r border-gray-300 bg-gray-100 overflow-y-auto">
                <div>
                    <label for="persona-input" class="block text-xs md:text-sm font-medium text-gray-800 mb-1">AI Persona Instructions:</label>
                    <textarea id="persona-input" rows="4" class="settings-input focus:ring-indigo-600 focus:border-indigo-600 text-sm" placeholder="e.g., You are a grumpy pirate captain..."></textarea>
                </div>
                <div class="mt-2">
                    <label for="max-history-input" class="block text-xs md:text-sm font-medium text-gray-800 mb-1">Chat History Turns to Send (Test):</label>
                    <input type="number" id="max-history-input" value="10" min="0" max="50" class="settings-input focus:ring-indigo-600 focus:border-indigo-600 text-sm w-24">
                </div>
                <div class="mt-4">
                    <h3 class="text-xs md:text-sm font-medium text-gray-800 mb-1">Error Log:</h3>
                    <div id="error-log-output">
                        </div>
                </div>
            </div>

            <div class="flex-1 flex flex-col bg-white overflow-hidden">
                <div id="chat-output" class="flex-1 p-4 md:p-6 space-y-3 overflow-y-auto message-container">
                    <div class="chat-bubble ai-bubble" data-message-id="initial-ai-message">
                        Set my persona, adjust history length, and send a message!
                        </div>
                </div>

                <div class="bg-gray-100 p-3 md:p-4 border-t border-gray-300">
                    <div class="flex items-center space-x-2 md:space-x-3">
                        <input type="text" id="message-input" class="flex-1 p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-600 focus:border-transparent outline-none text-sm md:text-base" placeholder="Type your message...">
                        <button id="send-button" class="bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-3 px-3 md:px-4 rounded-lg transition duration-150 ease-in-out text-sm md:text-base">
                            Send
                        </button>
                        <button id="resend-button" title="Resend last user message" class="bg-gray-500 hover:bg-gray-600 text-white font-semibold py-3 px-3 md:px-4 rounded-lg transition duration-150 ease-in-out text-sm md:text-base">
                            Resend User
                        </button>
                        <button id="reroll-ai-button" title="Reroll last AI response" class="bg-teal-500 hover:bg-teal-600 text-white font-semibold py-3 px-3 md:px-4 rounded-lg transition duration-150 ease-in-out text-sm md:text-base">
                            Reroll AI
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const chatOutput = document.getElementById('chat-output');
            const messageInput = document.getElementById('message-input');
            const sendButton = document.getElementById('send-button');
            const personaInput = document.getElementById('persona-input'); 
            const maxHistoryInput = document.getElementById('max-history-input'); 
            const errorLogOutput = document.getElementById('error-log-output');
            const resendButton = document.getElementById('resend-button');
            const rerollAIButton = document.getElementById('reroll-ai-button'); // New

            // --- Element Existence Checks ---
            if (!chatOutput || !messageInput || !sendButton || !personaInput || !maxHistoryInput || !errorLogOutput || !resendButton || !rerollAIButton) {
                console.error("One or more critical UI elements are missing!");
                // Optionally, disable buttons or show a general error message on the page
                if(sendButton) sendButton.disabled = true;
                if(resendButton) resendButton.disabled = true;
                if(rerollAIButton) rerollAIButton.disabled = true;
                return; // Stop script execution if critical elements are missing
            }

            let conversationHistoryForAPI = []; 
            let lastUserMessageText = ""; 
            let lastAIResponseBubble = null; // To keep track of the last AI message bubble for removal

            function displayMessage(messageText, sender, messageId = null) {
                if (!chatOutput) { console.error("displayMessage called but chatOutput is not available."); return; }
                const messageElement = document.createElement('div');
                messageElement.classList.add('chat-bubble');
                if (messageId) {
                    messageElement.dataset.messageId = messageId; // For potential future use
                }

                if (sender === 'User') {
                    messageElement.classList.add('user-bubble');
                    messageElement.textContent = `You: ${messageText}`;
                } else {
                    messageElement.classList.add('ai-bubble');
                    messageElement.textContent = `AI: ${messageText}`;
                    lastAIResponseBubble = messageElement; // Store reference to this AI bubble
                    // Example of adding a per-message reroll (more advanced, for later)
                    // const rerollBtn = document.createElement('button');
                    // rerollBtn.innerHTML = '&#x21BB;'; // Refresh symbol
                    // rerollBtn.className = 'reroll-ai-msg-btn';
                    // rerollBtn.onclick = () => handleRerollSpecificAIMessage(messageElement, conversationHistoryForAPI.length -1 ); // Pass index
                    // messageElement.appendChild(rerollBtn);
                }
                chatOutput.appendChild(messageElement);
                chatOutput.scrollTop = chatOutput.scrollHeight; 
            }

            function displayError(errorMessage) {
                if (!errorLogOutput) { console.error("displayError called but errorLogOutput is not available."); return; }
                const errorElement = document.createElement('div');
                errorElement.className = 'error-message'; 
                errorElement.textContent = `[${new Date().toLocaleTimeString()}] ${errorMessage}`;
                errorLogOutput.appendChild(errorElement);
                errorLogOutput.scrollTop = errorLogOutput.scrollHeight;
            }

            async function getAIResponse(userMessageTextForAPI, isReroll = false) {
                // If it's not a reroll, the user's message is new and needs to be added to history.
                // If it IS a reroll, the user's message is already the last "user" entry in history.
                if (!isReroll) {
                    conversationHistoryForAPI.push({ role: "user", parts: [{ text: userMessageTextForAPI }] });
                }

                const yourNetlifyProxyUrl = "/.netlify/functions/llm-proxy"; 
                const personaValue = personaInput.value.trim(); 
                const maxHistoryTurns = parseInt(maxHistoryInput.value, 10) || 10; 
                const maxHistoryItems = maxHistoryTurns * 2; 

                // The history sent to the API should be the current state of conversationHistoryForAPI
                // (which for a reroll, has had the previous AI response removed).
                let historyToSend = [...conversationHistoryForAPI]; 
                if (historyToSend.length > maxHistoryItems) {
                    historyToSend = historyToSend.slice(historyToSend.length - maxHistoryItems);
                }
                
                // If persona is present, and we are sending history, make sure persona is at the start
                // This is handled by the proxy now, but good to be mindful
                let actualPayloadHistory = historyToSend;
                // The proxy now handles prepending the persona if it's sent.

                console.log("Attempting to send to Netlify proxy:", yourNetlifyProxyUrl);
                console.log("Sending persona:", personaValue);
                console.log("Sending conversation history (trimmed for API call):", JSON.stringify(actualPayloadHistory, null, 2));

                try {
                    const payloadToProxy = {
                        history: actualPayloadHistory, 
                        persona: personaValue 
                    };

                    const response = await fetch(yourNetlifyProxyUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', },
                        body: JSON.stringify(payloadToProxy)
                    });

                    const result = await response.json(); 

                    if (!response.ok) {
                        const errorMsg = result.error || `Request to AI service failed (${response.status}, ${response.statusText})`;
                        console.error(`Error from proxy (Status ${response.status}):`, result);
                        displayError(errorMsg); 
                        return; 
                    }
                    
                    if (result.aiMessage) {
                        const aiResponseText = result.aiMessage;
                        displayMessage(aiResponseText, 'AI', `ai-${Date.now()}`); // Give AI messages a unique ID
                        conversationHistoryForAPI.push({ role: "model", parts: [{ text: aiResponseText }] });
                    } else if (result.error) {
                        console.error("Error message from proxy function:", result.error);
                        displayError(`Error from AI service: ${result.error}`); 
                    } else {
                        console.error("Unexpected response structure from proxy:", result);
                        displayError("Received an unexpected response from the AI service."); 
                    }
                } catch (error) {
                    console.error("Network or fetch error calling your backend proxy:", error);
                    displayError(`Network error or proxy is unreachable: ${error.message}`); 
                }
            }

            function handleSendMessage() {
                if (!messageInput) return; 
                const messageText = messageInput.value.trim();
                if (messageText) {
                    displayMessage(messageText, 'User', `user-${Date.now()}`); 
                    lastUserMessageText = messageText; 
                    messageInput.value = ''; 
                    getAIResponse(messageText, false); // false indicates it's not a reroll
                }
            }
            
            function handleResendMessage() {
                if (lastUserMessageText) {
                    console.log("Resending last user message:", lastUserMessageText);
                    displayMessage(lastUserMessageText, 'User', `user-${Date.now()}-resend`); 
                    // When resending, the lastUserMessageText is added again to history by getAIResponse
                    getAIResponse(lastUserMessageText, false); // Treat as a new send of that message
                } else {
                    displayError("No last user message to resend.");
                }
            }

            function handleRerollAI() {
                if (conversationHistoryForAPI.length < 2) { // Need at least one user message and one AI response
                    displayError("Not enough conversation history to reroll an AI response.");
                    return;
                }

                // Find the last AI response and the user message that prompted it
                let lastAiIndex = -1;
                for (let i = conversationHistoryForAPI.length - 1; i >= 0; i--) {
                    if (conversationHistoryForAPI[i].role === "model") {
                        lastAiIndex = i;
                        break;
                    }
                }

                if (lastAiIndex === -1 || lastAiIndex === 0) { // No AI response found, or AI spoke first (unlikely with current flow)
                    displayError("No previous AI response found to reroll.");
                    return;
                }
                
                // The user message is before the last AI message
                const userMessageToResubmit = conversationHistoryForAPI[lastAiIndex - 1];

                if (userMessageToResubmit && userMessageToResubmit.role === "user") {
                    // Remove the last AI response from history
                    conversationHistoryForAPI.splice(lastAiIndex, 1); 

                    // Remove the last AI message bubble from the display
                    if (lastAIResponseBubble && lastAIResponseBubble.parentNode === chatOutput) {
                        chatOutput.removeChild(lastAIResponseBubble);
                        lastAIResponseBubble = null; // Clear the reference
                    } else {
                        // Fallback if lastAIResponseBubble isn't set or already removed: find last .ai-bubble
                        const allAiBubbles = chatOutput.querySelectorAll('.ai-bubble');
                        if (allAiBubbles.length > 0) {
                            chatOutput.removeChild(allAiBubbles[allAiBubbles.length - 1]);
                        }
                    }
                    
                    // Display the user message again to show what we are responding to (optional, could be confusing)
                    // displayMessage(userMessageToResubmit.parts[0].text, 'User'); 
                    
                    console.log("Rerolling AI response for user message:", userMessageToResubmit.parts[0].text);
                    // Call getAIResponse. It will take the userMessageToResubmit.parts[0].text and add it to history again.
                    // So, we need to ensure the history sent to getAIResponse is correct.
                    // The history *before* the user message we want to resubmit is needed.
                    // For a simple reroll, we can just pop the last user message (which prompted the AI we removed)
                    // and then let getAIResponse re-add it.
                    
                    // The conversationHistoryForAPI now ends with the user message that prompted the AI we removed.
                    // We want to effectively call getAIResponse with that user message again.
                    // The getAIResponse function expects the *text* of the user message.
                    getAIResponse(userMessageToResubmit.parts[0].text, true); // true indicates it's a reroll

                } else {
                    displayError("Could not find the preceding user message to reroll the AI response.");
                }
            }

            // --- Event Listeners ---
            if (sendButton) sendButton.addEventListener('click', handleSendMessage);
            if (messageInput) messageInput.addEventListener('keypress', function(event) { if (event.key === 'Enter') handleSendMessage(); });
            if (resendButton) resendButton.addEventListener('click', handleResendMessage);
            if (rerollAIButton) rerollAIButton.addEventListener('click', handleRerollAI); // New
        });
    </script>
</body>
</html>
```

**Key Changes in this Version:**

1.  **HTML:**
    * Added `<button id="reroll-ai-button" ...>Reroll AI</button>` in the input area.
    * Slightly adjusted button padding for smaller screens.
2.  **JavaScript:**
    * **`rerollAIButton`:** Fetched by ID.
    * **`lastAIResponseBubble` variable:** Added to keep a reference to the DOM element of the last AI message bubble, making it easier to remove. This is updated in `displayMessage` when an AI message is shown.
    * **Modified `getAIResponse(userMessageTextForAPI, isReroll = false)`:**
        * Added an `isReroll` parameter (defaults to `false`).
        * If `isReroll` is `false` (a normal send), it pushes the `userMessageTextForAPI` to `conversationHistoryForAPI` as before.
        * If `isReroll` is `true`, it *doesn't* add the `userMessageTextForAPI` to history because it's assumed that message is already the last "user" entry (after the previous AI response was popped).
    * **New `handleRerollAI()` function:**
        * Checks if there's enough history to reroll (at least one user message and one AI response).
        * Finds the index of the last AI message (`role: "model"`) in `conversationHistoryForAPI`.
        * Identifies the user message that prompted that AI response (the item before it in history).
        * Removes the last AI response from `conversationHistoryForAPI` using `splice()`.
        * Removes the corresponding AI message bubble from the `chatOutput` div using `removeChild(lastAIResponseBubble)` or a fallback.
        * Calls `getAIResponse()` again, passing the *text* of the user message that prompted the removed AI response, and sets `isReroll` to `true`.
    * Event listener added for the `rerollAIButton`.

**How the Reroll Logic Works (Simplified for Prototype):**

1.  When you click "Reroll AI":
2.  It looks at the `conversationHistoryForAPI`.
3.  It finds the last message that was from the "model" (the AI).
4.  It also finds the "user" message that came just before that AI message.
5.  It removes the AI's message from the history array and from the screen.
6.  It then calls `getAIResponse` again, essentially telling it to generate a new response to that *same previous user message*.

This is a basic implementation. More advanced versions might store the different AI responses for a single user prompt, allowing you to cycle through them, but this gives you the core "try again" functionality.

Remember to update your `index.html` on GitHub, let Netlify deploy, and then test it o
